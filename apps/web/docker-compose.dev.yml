services:
  # Development version with hot reload
  gt7-app-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_CONVEX_URL=http://localhost:3210
      - CONVEX_DEPLOYMENT=${CONVEX_DEPLOYMENT:-anonymous:anonymous-gt7-data-analysis}
      - WATCHPACK_POLLING=true
      # Authentication environment variables
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-gt7-super-secret-key-for-development}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      # Stripe environment variables (optional)
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
    volumes:
      # Mount source code for hot reload
      - .:/app
      - /app/node_modules
      - /app/.next
    networks:
      - gt7-network
    restart: unless-stopped
    stdin_open: true
    tty: true

  # Convex development server
  convex-dev:
    image: node:18-alpine
    working_dir: /app
    command: sh -c "npm install -g convex && convex dev"
    ports:
      - "3210:3210"
      - "8187:8187"
    environment:
      - CONVEX_DEPLOYMENT=${CONVEX_DEPLOYMENT:-anonymous:anonymous-gt7-data-analysis}
    volumes:
      - ./convex:/app/convex
      - ./package.json:/app/package.json
      - convex_data:/app/.convex
    networks:
      - gt7-network
    restart: unless-stopped

volumes:
  convex_data:
    driver: local

networks:
  gt7-network:
    driver: bridge